# ElementOperation 模块

## 模块概述

ElementOperation 模块提供对 Revit 元素的各种操作和控制功能，是 AI 系统与 Revit 元素交互的重要组件。该模块支持元素的选择、视觉效果设置、显示控制、以及删除等操作，为 AI 系统提供了丰富的元素管理能力。

## 主要功能

- **选择控制**: 精确选择单个或多个元素，支持选择框操作
- **视觉效果**: 设置元素颜色、透明度，实现高亮和标记效果
- **显示管理**: 控制元素的隐藏、显示、隔离状态
- **元素删除**: 安全删除指定的元素
- **批量操作**: 支持对多个元素执行相同操作

## 核心组件

### 1. OperateElementCommand
- **类型**: ExternalEventCommandBase
- **命令名**: `operate_element`
- **功能**: 接收操作参数，触发异步操作执行

### 2. OperateElementEventHandler
- **类型**: IExternalEventHandler + IWaitableExternalEventHandler
- **功能**: 在 Revit 主线程中执行具体的元素操作

## API 接口

### 命令调用

```json
{
  "data": {
    "elementIds": [123456, 789012, 345678],
    "action": "SetColor",
    "colorValue": [255, 0, 0],
    "transparencyValue": 50
  }
}
```

### 参数说明 (OperationSetting)

| 参数名 | 类型 | 默认值 | 必填 | 说明 |
|--------|------|--------|------|------|
| `elementIds` | number[] | - | 是 | 需要操作的Revit元素ID数组 |
| `action` | string | - | 是 | 操作类型 (见下表详细说明) |
| `colorValue` | number[3] | [255, 0, 0] | 否 | SetColor操作的RGB颜色值，默认红色 |
| `transparencyValue` | number | 50 | 否 | SetTransparency操作的透明度值 (0-100) |

### 支持的操作类型 (Action Types)

| 操作类型 | 英文名称 | 说明 | 需要参数 |
|----------|----------|------|----------|
| 选择 | `Select` | 在活动视图中启用直接元素选择 | 无 |
| 选择框 | `SelectionBox` | 通过在视图中绘制矩形窗口来选择元素 | 无 |
| 设置颜色 | `SetColor` | 更改元素的颜色 | colorValue |
| 设置透明度 | `SetTransparency` | 调整元素透明度 | transparencyValue |
| 删除 | `Delete` | 从项目中永久删除元素 | 无 |
| 隐藏 | `Hide` | 在当前视图中隐藏元素直到明确显示 | 无 |
| 临时隐藏 | `TempHide` | 在当前视图中临时隐藏元素 | 无 |
| 隔离 | `Isolate` | 仅显示选定元素，隐藏所有其他元素 | 无 |
| 取消隐藏 | `Unhide` | 显示之前隐藏的元素 | 无 |
| 重置隔离 | `ResetIsolate` | 恢复视图的正常可见性 | 无 |
| 高亮显示 | `Highlight` | 便捷操作，将元素设为红色（内部调用SetColor） | 无 |

### 返回格式

```json
{
  "Success": true,
  "Message": "操作成功",
  "Response": {
    "OperationType": "SetColor",
    "ProcessedCount": 3,
    "SuccessfulElements": [123456, 789012, 345678],
    "FailedElements": [],
    "Details": "已将3个元素设置为红色"
  }
}
```

## 使用示例

### 1. 选择元素

```json
{
  "data": {
    "elementIds": [123456],
    "action": "Select"
  }
}
```

### 2. 设置元素颜色

```json
{
  "data": {
    "elementIds": [123456, 789012],
    "action": "SetColor",
    "colorValue": [255, 0, 0]
  }
}
```

### 3. 设置元素透明度

```json
{
  "data": {
    "elementIds": [123456],
    "action": "SetTransparency",
    "transparencyValue": 70
  }
}
```

### 4. 隔离显示元素

```json
{
  "data": {
    "elementIds": [123456, 789012, 345678],
    "action": "Isolate"
  }
}
```

### 5. 批量删除元素

```json
{
  "data": {
    "elementIds": [123456, 789012],
    "action": "Delete"
  }
}
```

### 6. 高亮显示问题元素

```json
{
  "data": {
    "elementIds": [123456],
    "action": "Highlight"
  }
}
```

## 操作详细说明

### 选择操作

#### Select (选择)
- **功能**: 在 Revit 界面中选中指定元素
- **效果**: 元素被选中，可进行后续编辑操作
- **适用场景**: 需要用户进一步编辑元素时

#### SelectionBox (选择框)
- **功能**: 在3D视图中显示元素的边界框
- **效果**: 绘制包围指定元素的3D框架
- **适用场景**: 空间分析、碰撞检测

### 视觉效果操作

#### SetColor (设置颜色)
- **功能**: 改变元素的显示颜色
- **参数**: colorValue [R, G, B] (0-255)
- **效果**: 元素以指定颜色显示
- **应用**: 问题标记、分类显示、热力图等

#### SetTransparency (设置透明度)
- **功能**: 调整元素的透明度
- **参数**: transparencyValue (0-100, 0为不透明)
- **效果**: 元素半透明显示
- **应用**: 层次分析、透视效果

#### Highlight (高亮显示)
- **功能**: 快速将元素设为红色高亮
- **效果**: 等同于 SetColor [255, 0, 0]
- **应用**: 快速标记重要元素

### 显示控制操作

#### Hide (隐藏)
- **功能**: 在当前视图中隐藏元素
- **效果**: 元素不可见但仍存在于模型中
- **范围**: 仅当前视图
- **可逆**: 可通过 Unhide 恢复

#### TempHide (临时隐藏)
- **功能**: 临时隐藏元素
- **效果**: 临时隐藏，刷新视图后恢复
- **适用**: 临时清理视图

#### Isolate (隔离)
- **功能**: 只显示指定元素，隐藏其他所有元素
- **效果**: 视图中只显示选定元素
- **应用**: 专注分析特定元素

#### Unhide (取消隐藏)
- **功能**: 显示之前隐藏的元素
- **效果**: 恢复元素的可见性

#### ResetIsolate (重置隔离)
- **功能**: 恢复视图的正常显示状态
- **效果**: 取消所有隔离，显示所有元素

### 删除操作

#### Delete (删除)
- **功能**: 永久删除元素
- **警告**: 操作不可逆，请谨慎使用
- **限制**: 某些系统元素可能无法删除
- **建议**: 删除前进行数据备份

## 颜色系统

### 标准颜色值

| 颜色 | RGB值 | 用途 |
|------|-------|------|
| 红色 | [255, 0, 0] | 错误、警告、高亮 |
| 绿色 | [0, 255, 0] | 正确、通过、正常 |
| 蓝色 | [0, 0, 255] | 信息、冷色调 |
| 黄色 | [255, 255, 0] | 注意、警示 |
| 橙色 | [255, 165, 0] | 中等警告 |
| 紫色 | [128, 0, 128] | 特殊标记 |
| 灰色 | [128, 128, 128] | 次要信息 |
| 黑色 | [0, 0, 0] | 默认、强调 |
| 白色 | [255, 255, 255] | 背景、反色 |

### 透明度指南

| 透明度值 | 效果 | 适用场景 |
|----------|------|----------|
| 0-20 | 基本不透明 | 正常显示 |
| 21-40 | 轻微透明 | 次要元素 |
| 41-60 | 半透明 | 参考元素 |
| 61-80 | 高透明 | 背景元素 |
| 81-100 | 接近透明 | 辅助参考 |

## 批量操作最佳实践

### 性能优化
1. **合理分组**: 按操作类型对元素进行分组
2. **限制数量**: 单次操作建议不超过1000个元素
3. **分批处理**: 大量元素分批执行操作

### 错误处理
1. **验证存在**: 操作前验证元素是否存在
2. **权限检查**: 确认元素可以被修改或删除
3. **异常恢复**: 提供操作失败后的恢复机制

### 用户体验
1. **操作反馈**: 提供清晰的操作结果反馈
2. **进度提示**: 大批量操作时显示进度
3. **撤销支持**: 危险操作前提供确认机制

## 常见应用场景

### 1. 质量检查标记
```json
// 标记有问题的墙体为红色
{
  "data": {
    "elementIds": [123456, 789012],
    "action": "SetColor",
    "colorValue": [255, 0, 0]
  }
}
```

### 2. 空间分析
```json
// 隔离显示特定房间的所有元素
{
  "data": {
    "elementIds": [房间内所有元素ID],
    "action": "Isolate"
  }
}
```

### 3. 分阶段显示
```json
// 将下一阶段的元素设为半透明
{
  "data": {
    "elementIds": [下阶段元素ID],
    "action": "SetTransparency",
    "transparencyValue": 60
  }
}
```

### 4. 临时清理视图
```json
// 临时隐藏管线以查看结构
{
  "data": {
    "elementIds": [管线元素ID],
    "action": "TempHide"
  }
}
```

## 错误处理

### 常见错误

1. **元素不存在**
   - 原因: 提供的ElementId无效
   - 解决: 先查询验证元素存在性

2. **操作权限不足**
   - 原因: 元素被锁定或只读
   - 解决: 检查元素编辑权限

3. **视图限制**
   - 原因: 当前视图不支持某些操作
   - 解决: 切换到合适的视图类型

4. **参数无效**
   - 原因: 颜色值或透明度值超出范围
   - 解决: 验证参数有效性

### 错误返回示例

```json
{
  "Success": false,
  "Message": "操作部分失败",
  "Response": {
    "OperationType": "Delete",
    "ProcessedCount": 2,
    "SuccessfulElements": [123456],
    "FailedElements": [789012],
    "Details": "元素789012无法删除：元素被约束"
  }
}
```

## 相关文件

- `OperateElementCommand.cs` - 操作命令入口
- `OperateElementEventHandler.cs` - 操作逻辑实现
- `Models/Common/OperationSetting.cs` - 操作参数模型
- `Models/Common/AIResult.cs` - 统一返回格式